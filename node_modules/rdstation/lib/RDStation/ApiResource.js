'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _Exception = require('./Exception/Exception');

var _Exception2 = _interopRequireDefault(_Exception);

var _Request = require('./Request');

var _Request2 = _interopRequireDefault(_Request);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ApiResource {
    /**
     * Constructor
     *
     * @param {AccessToken} $accessToken
     */
    constructor($accessToken) {
        this.accessToken = $accessToken;
    }

    /**
     * @return {AccessToken}
     */
    get accessToken() {
        return this.accessToken;
    }

    /**
     * @param {AccessToken} val
     */
    set accessToken(val) {
        this.accessToken = val;
    }

    /**
     *
     * @param {string} method
     * @param {string} endpoint
     * @param {Object} data
     * @param {Object} headers
     * @param {Object} fetchInitOpts
     */
    request(method, endpoint, data = {}, headers = {}, fetchInitOpts = {}) {
        try {
            response = _Request2.default.send(method, endpoint, data, Object.assign({
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.accessToken.getToken()}`
            }, headers), fetchInitOpts);
        } catch (e) {
            // invalid access token? refresh and try again
            if (e.hasErrorType(_Exception2.default.TYPE_UNAUTHORIZED)) {
                this.accessToken.refresh();
                response = _Request2.default.send(method, endpoint, data, Object.assign({
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.accessToken.getToken()}`
                }, headers), fetchInitOpts);
            } else {
                throw $e;
            }
        }

        return response;
    }
}
exports.default = ApiResource;